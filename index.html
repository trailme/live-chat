<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Trailme - Leaderboard</title>
    <style>
        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo.svg#webfont) format("svg");
            font-weight: 300;
            font-style: normal;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Italic.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Italic.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Italic.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Italic.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Italic.svg#webfont) format("svg");
            font-weight: 300;
            font-style: italic;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Light.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Light.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Light.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Light.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Light.svg#webfont) format("svg");
            font-weight: 200;
            font-style: normal;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-LightItalic.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-LightItalic.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-LightItalic.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-LightItalic.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-LightItalic.svg#webfont) format("svg");
            font-weight: 200;
            font-style: italic;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Thin.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Thin.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Thin.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Thin.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Thin.svg#webfont) format("svg");
            font-weight: 100;
            font-style: normal;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-ThinItalic.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-ThinItalic.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-ThinItalic.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-ThinItalic.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-ThinItalic.svg#webfont) format("svg");
            font-weight: 100;
            font-style: italic;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Medium.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Medium.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Medium.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Medium.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Medium.svg#webfont) format("svg");
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-MediumItalic.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-MediumItalic.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-MediumItalic.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-MediumItalic.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-MediumItalic.svg#webfont) format("svg");
            font-weight: 400;
            font-style: italic;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Bold.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Bold.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Bold.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Bold.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Bold.svg#webfont) format("svg");
            font-weight: 500;
            font-style: normal;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BoldItalic.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BoldItalic.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BoldItalic.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BoldItalic.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BoldItalic.svg#webfont) format("svg");
            font-weight: 500;
            font-style: italic;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBold.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBold.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBold.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBold.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBold.svg#webfont) format("svg");
            font-weight: 600;
            font-style: normal;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBoldItalic.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBoldItalic.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBoldItalic.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBoldItalic.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-XBoldItalic.svg#webfont) format("svg");
            font-weight: 600;
            font-style: italic;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Black.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Black.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Black.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Black.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-Black.svg#webfont) format("svg");
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: "Prometo";
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BlackItalic.eot);
            src: url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BlackItalic.eot#iefix) format("embedded-opentype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BlackItalic.woff) format("woff"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BlackItalic.ttf) format("truetype"), url(https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo-BlackItalic.svg#webfont) format("svg");
            font-weight: 700;
            font-style: italic;
        }


        body {
            margin: 0;
            overflow-x: hidden;
            width: 100vw;
            font-family: 'Prometo', Arial;
            /* padding-top: 150px; */
            /* (https://staging.trailme.com.hk/sites/default/themes/trail/fonts/prometo/Prometo.eot) */
        }
    </style>
    <!--== Favicon ==-->
    <!-- <link rel="shortcut icon" href="assets/img/favicon.ico" type="image/x-icon" /> -->

    <script src="confetti.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <link rel="shortcut icon" href="https://www.trailme.com.hk/sites/default/themes/trail/favicon.ico" />

    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" defer></script>
    <script>
        window.OneSignal = window.OneSignal || [];
        OneSignal.push(function () {
            OneSignal.init({
                appId: "0b042884-8c66-4491-8bed-52f5f1027d3c",
            });
        });
    </script>



    <!--== Google Fonts ==-->
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;0,900;1,300;1,400&display=swap"
        rel="stylesheet">

    <!-- build:css assets/css/app.min.css -->
    <!--== jqvmap Min CSS ==-->
    <link href="assets/css/jqvmap.min.css" rel="stylesheet" />
    <!--== ChartJS Min CSS ==-->
    <link href="assets/css/chart.min.css" rel="stylesheet" />
    <!--== DataTables Min CSS ==-->
    <link href="assets/css/datatables.min.css" rel="stylesheet" />
    <!--== Select2 Min CSS ==-->
    <link href="assets/css/select2.min.css" rel="stylesheet" />
    <!--== Bootstrap Min CSS ==-->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />

    <!--== Main Style CSS ==-->
    <link href="assets/css/style.css" rel="stylesheet" />
    <!-- endbuild -->

    <style>
        /* The container */
        .container {
            display: block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 22px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;

        }

        /* Hide the browser's default checkbox */
        .container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        /* Create a custom checkbox */
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 25px;
            width: 25px;
            background-color: #eee;
            border-radius: 5px;
        }

        /* On mouse-over, add a grey background color */
        .container:hover input~.checkmark {
            background-color: rgba(238, 238, 238, 0.805);
            border-radius: 5px;
        }

        /* When the checkbox is checked, add a blue background */
        .container input:checked~.checkmark {
            background-color: #2196F3;
            border-radius: 5px;
        }

        /* Create the checkmark/indicator (hidden when not checked) */
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;

        }

        /* Show the checkmark when checked */
        .container input:checked~.checkmark:after {
            display: block;
        }

        /* Style the checkmark/indicator */
        .container .checkmark:after {
            left: 9px;
            top: 5px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            transform: rotate(45deg);

        }
    </style>

    <style>
        .bounce-enter-active {
            animation: bounce-in 0.5s;
        }

        .bounce-leave-active {
            animation: bounce-in 0.5s reverse;
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.25);
            }

            100% {
                transform: scale(1);
            }
        }


        .mapboxgl-marker {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 1px solid gray;
            background-color: lightblue;
        }
    </style>

    <style>
        .myclickable:hover {
            cursor: pointer;
        }

        .form-search {
            box-sizing: border-box;
            height: 50px;
            border: 0;
            /* border-radius: 20px; */
            width: 100%;
            padding: 0 20px 0 20px;
            background: none;
            background: rgba(238, 238, 238, 0.805);

            /* box-shadow: 0px 0px 30px 0px rgb(0 0 0 / 15%); */
        }

        .sorticon {
            width: 17px;
            margin-left: 5px;
            opacity: .4;
        }

        .sorticon:hover {
            cursor: pointer;
        }

        .filterbutton {
            width: 100%;
            padding: 12px;
            padding-right: 25px;
            padding-top: 16px;
        }

        .filterbutton:hover {
            cursor: pointer;
        }

        .filtertag {
            display: inline-block;
            border: 2px solid #008cd1;
            border-radius: 20px;
            color: #008cd1;
            padding: 5px 15px;
            margin-left: 10px;
            margin-bottom: 10px;
        }

        .filtertag:hover {
            display: inline-block;
            border: 2px solid #2da04d;
            border-radius: 20px;
            color: #2da04d;
        }

        .clickbefore {
            background: rgba(255, 255, 255, 0.861);
            opacity: .85;
        }


        .clickafter {
            background: rgba(255, 255, 255, 0.961);
            opacity: .95;
        }

        .clickafter:hover,
        .clickbefore:hover {
            cursor: pointer;
        }

        .myselection:hover {
            background: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }


        div::-webkit-scrollbar {
            display: none;
        }

        .courseselect {
            width: 120px;
            background: rgba(255, 255, 255, 0.781);
            text-align: center;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 10px;
        }

        .courseselect:hover {
            cursor: pointer;
            background: white;
        }
    </style>

    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";

        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";

        import { doc, getDoc, onSnapshot, getFirestore } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";



        const firebaseConfig = {

            apiKey: "AIzaSyAjvRZXmI5rF9rVmZF7hcFy13t26d_fdyY",

            authDomain: "trailme-leaderboard.firebaseapp.com",

            projectId: "trailme-leaderboard",

            storageBucket: "trailme-leaderboard.appspot.com",

            messagingSenderId: "134824345234",

            appId: "1:134824345234:web:d6a4206908df27812b304b",

            measurementId: "G-ZSWKJ725KH"

        };

        const app = initializeApp(firebaseConfig);

        const db = getFirestore(app);


        async function getUserProfile(userId) {
            const docRef = doc(db, "Users", userId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const result = docSnap.data()
                console.log("Document data:", result);
                return result
            } else {
                // docSnap.data() will be undefined in this case
                console.log("No such document!");
                return {}
            }

        }

        // getUserProfile('5dc0f414b3c5d040e5a26836')


        const queryString = window.location.search
        const urlParams = new URLSearchParams(queryString)
        const courseid = urlParams.get('courseid')
        const eventid = urlParams.get('eventid')
        const zoom = urlParams.get('zoom')
        console.log(courseid)
        console.log(eventid)
        let firstin = true
        // var map


        async function getcoursesbyeventid() {
            const url = 'https://1f53v2wgyk.execute-api.us-east-1.amazonaws.com/getcoursebyeventid/' + eventid
            const courselist = await new Promise((resolve, reject) => {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        // Typical action to be performed when the document is ready:
                        resolve(JSON.parse(xhttp.responseText))
                    }
                };
                xhttp.open("GET", url, true);
                xhttp.send();
            })
            VueApp.$data.courselist = courselist.data
            return courselist.data
        }



        setTimeout(() => {
            VueApp.$data.courseid = courseid ? courseid : false
            VueApp.$data.eventid = eventid ? eventid : false
            if (eventid) {
                const courselist = getcoursesbyeventid(eventid)
            }

        }, 100);




        function initmap(mapboxUrl) {

            mapboxgl.accessToken = 'pk.eyJ1IjoidWhleSIsImEiOiJjank0YTllNWwxMTQzM25sZ3d1eWZwbjZmIn0.QKWNjXBpjvLszcNJkNXILw';
            map = new mapboxgl.Map({
                container: 'mapboxframe',
                // style: "mapbox://styles/uhey/clcr1op2s000m14o1trv5imdy"
                style: mapboxUrl
            });



            map.on('load', () => {
                VueApp.getUserProfile = getUserProfile
                VueApp.flytomap = (coordinates) => {
                    map.flyTo({
                        center: coordinates,
                        speed: 1,
                        zoom: parseFloat(zoom) || 15.2,
                    });
                }
                // map.loadImage(
                //     'https://i.ibb.co/CB8YgPQ/kisspng-running-jogging-free-content-clip-art-run-away-cliparts-5a873ffb59e6a0-357249031518813179368.png',
                //     // 'https://banner2.cleanpng.com/20180216/uke/kisspng-running-jogging-free-content-clip-art-run-away-cliparts-5a873ffb338d26.8318981415188131792112.jpg',
                //     (error, image) => {
                //         if (error) throw error;

                //         // Add the image to the map style.
                //         map.addImage('cat', image);

                //         // Add a data source containing one point feature.
                //         map.addSource('point', {
                //             'type': 'geojson',
                //             'data': {
                //                 'type': 'FeatureCollection',
                //                 'features': [
                //                     {
                //                         'type': 'Feature',
                //                         'geometry': {
                //                             'type': 'Point',
                //                             'coordinates': [114.261706, 22.301909]
                //                         }
                //                     },
                //                     {
                //                         'type': 'Feature',
                //                         'geometry': {
                //                             'type': 'Point',
                //                             'coordinates': [114.261756, 22.301919]
                //                         }
                //                     }
                //                 ]
                //             }
                //         });

                //         // Add a layer to use the image to represent the data.
                //         map.addLayer({
                //             'id': 'points',
                //             'type': 'symbol',
                //             'source': 'point', // reference the data source
                //             'layout': {
                //                 'icon-image': 'cat', // reference the image
                //                 'icon-size': 0.15
                //             }
                //         });

                //         startlivetracking()

                //     }
                // );

                startlivetracking()
                onSnapshot(
                    doc(db, "Beacons", courseid),
                    { includeMetadataChanges: true },
                    (doc) => {

                        let nowdata = doc.data()
                        let beaconpoints = []
                        for (var j in nowdata) {
                            beaconpoints.push({
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [nowdata[j].longitude, nowdata[j].latitude],
                                    tolerance: 0
                                }
                            })
                        }
                        if (map) {
                            if (!map.getSource('point')) {
                                map.loadImage(
                                    'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/WhiteDot.svg/1024px-WhiteDot.svg.png',
                                    (error, image2) => {
                                        if (error) throw error;

                                        // Add the image to the map style.
                                        map.addImage('beacon', image2);

                                        // Add a data source containing one point feature.
                                        map.addSource('beacon', {
                                            'type': 'geojson',
                                            'data': {
                                                'type': 'FeatureCollection',
                                                'features': beaconpoints
                                            }
                                        });

                                        // Add a layer to use the image to represent the data.
                                        map.addLayer({
                                            'id': 'beacons',
                                            'type': 'symbol',
                                            'source': 'beacon', // reference the data source
                                            'layout': {
                                                'icon-image': 'beacon', // reference the image
                                                'icon-size': 0.01
                                            }
                                        });
                                        console.log(zoom)
                                        console.log(parseFloat(zoom) || 15.2)
                                        map.flyTo({
                                            center: beaconpoints[0].geometry.coordinates,
                                            speed: 1,
                                            zoom: parseFloat(zoom) || 15.2,
                                        });


                                        // startlivetracking()

                                    }
                                );

                            }

                        }


                    });


            });


        }


        let userIdDetails = {}
        const unsub = onSnapshot(
            doc(db, "LeaderBoardLive", courseid),
            { includeMetadataChanges: true },
            (doc) => {
                console.log('updated')
                let nowdata = doc.data()
                let racestat = {}
                let tempdata = []
                for (var j in nowdata.data)
                    tempdata.push(nowdata.data[j])
                nowdata.data = tempdata
                nowdata.data.map(x => {

                    if (!userIdDetails[x.userId])
                        userIdDetails[x.userId] = x
                    else if (x.createdAt.seconds > userIdDetails[x.userId].createdAt.seconds)
                        userIdDetails[x.userId] = x
                    racestat[x.racerStatus] = racestat[x.racerStatus] ? racestat[x.racerStatus] + 1 : 1


                })
                VueApp.$data.racerdata = nowdata
                VueApp.$data.stat = racestat
                VueApp.sortByCompleteTime()


                if (!map) {
                    console.log('init map')
                    initmap(nowdata.courseDetails.mapboxUrl)
                } else {
                    console.log('update user details')
                    VueApp.updatemap()
                }


            });



        function startlivetracking() {
            const unsub2 = onSnapshot(
                doc(db, "LiveMap", courseid),
                { includeMetadataChanges: true },
                (doc) => {
                    let nowdata = doc.data()
                    VueApp.$data.livemapdata = nowdata
                    VueApp.updatemap()
                });
        }



    </script>
</head>

<body style="background: linear-gradient(#008cd1,#2da04d);">
    <div id="app">


        <div id="onlinestatus"
            style="background: rgba(255, 255, 255, 0.861); position: fixed; top: 20px; left: 20px; border-radius: 5px; z-index:999; padding: 5px 10px; opacity: .85;">
            <div style="width: 10px; height: 10px; border-radius: 50%; background: #2da04d; display: inline-block;">
            </div>
            {{connectCounter}}
        </div>

        <div :class="{clickafter: sidepanelmode=='chat', clickbefore: !(sidepanelmode=='chat')}"
            style=" position: fixed; top: 20px; left: 80px; border-radius: 5px; z-index:999; padding: 5px 10px;"
            @click="switchsidepanelmode('chat')">
            <!-- <div style="width: 10px; height: 10px; border-radius: 50%; background: #2da04d; display: inline-block;">
            </div> -->
            <img style="width: 15px;" src="https://cdn-icons-png.flaticon.com/512/1380/1380370.png">
            Chat
        </div>


        <div :class="{clickafter: sidepanelmode=='tracking', clickbefore: !(sidepanelmode=='tracking')}"
            style="position: fixed; top: 20px; left: 160px; border-radius: 5px; z-index:999; padding: 5px 10px;"
            @click="switchsidepanelmode('tracking')">
            <!-- <div style="width: 10px; height: 10px; border-radius: 50%; background: #2da04d; display: inline-block;">
        </div> -->
            <img style="width: 15px;" src="https://cdn-icons-png.flaticon.com/512/109/109732.png">
            Tracking
        </div>


        <div v-if="!courseid && !eventid"
            style="position: fixed; left: 0; right: 0; margin-left: auto; margin-right: auto; background: rgba(255, 255, 255, 0.674); border-radius: 10px; width: 80vw; text-align: center; padding: 20px 20px; top: 100px; opacity: 1; max-width: 1000px;">
            <h1>Select {{chooselvl}}</h1>
            <div v-if="chooselvl=='Event'" class="row" style="height: calc(100vh - 250px); overflow-y: scroll;">
                <div v-if="eventdata.length<=0">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                        style="margin:auto;background:rgba(255, 255, 255, 0);display:block;" width="204px"
                        height="204px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
                        <circle cx="77" cy="50" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.8571428571428571s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.8571428571428571s">
                            </animate>
                        </circle>
                        <circle cx="66.8342246501858" cy="71.10945002663681" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.7142857142857143s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.7142857142857143s">
                            </animate>
                        </circle>
                        <circle cx="43.991934783179516" cy="76.32305362890924" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.5714285714285714s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.5714285714285714s">
                            </animate>
                        </circle>
                        <circle cx="25.673840566634688" cy="61.71486095617407" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.42857142857142855s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.42857142857142855s">
                            </animate>
                        </circle>
                        <circle cx="25.673840566634684" cy="38.285139043825936" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.2857142857142857s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.2857142857142857s">
                            </animate>
                        </circle>
                        <circle cx="43.9919347831795" cy="23.67694637109076" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.14285714285714285s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.14285714285714285s">
                            </animate>
                        </circle>
                        <circle cx="66.8342246501858" cy="28.890549973363193" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="0s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="0s"></animate>
                        </circle>
                    </svg>
                </div>



                <div @click="chooseevent(item)" v-for="item in eventdata.filter(x=>x.isPublished)"
                    class="col-3 myselection" style=" margin-bottom: 10px;">
                    <div><img style="width: 350px; height: 100px; border-radius: 5px; object-fit: cover;"
                            :src="item.image">
                    </div>

                    <div style="font-size: 13px;">
                        {{item.name}}
                    </div>
                </div>
            </div>
            <div v-if="chooselvl=='Course'" class="row" style="height: calc(100vh - 250px); overflow-y: scroll;">
                <div v-if="coursedata.length<=0">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                        style="margin:auto;background:rgba(255, 255, 255, 0);display:block;" width="204px"
                        height="204px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
                        <circle cx="77" cy="50" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.8571428571428571s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.8571428571428571s">
                            </animate>
                        </circle>
                        <circle cx="66.8342246501858" cy="71.10945002663681" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.7142857142857143s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.7142857142857143s">
                            </animate>
                        </circle>
                        <circle cx="43.991934783179516" cy="76.32305362890924" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.5714285714285714s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.5714285714285714s">
                            </animate>
                        </circle>
                        <circle cx="25.673840566634688" cy="61.71486095617407" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.42857142857142855s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.42857142857142855s">
                            </animate>
                        </circle>
                        <circle cx="25.673840566634684" cy="38.285139043825936" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.2857142857142857s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.2857142857142857s">
                            </animate>
                        </circle>
                        <circle cx="43.9919347831795" cy="23.67694637109076" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="-0.14285714285714285s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.14285714285714285s">
                            </animate>
                        </circle>
                        <circle cx="66.8342246501858" cy="28.890549973363193" fill="#008cd1" r="7">
                            <animate attributeName="r" values="4.2;4.2;7;4.2;4.2" times="0;0.1;0.2;0.3;1" dur="1s"
                                repeatCount="indefinite" begin="0s"></animate>
                            <animate attributeName="fill" values="#008cd1;#008cd1;#2da04d;#008cd1;#008cd1"
                                repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="0s"></animate>
                        </circle>
                    </svg>
                </div>
                <div v-for="item in coursedata" class="col-3 myselection"
                    style=" margin-bottom: 10px; max-height: 150px;">
                    <a :href="'?courseid='+item._id+'&eventid='+targeteventid" style="color: black;">
                        <div><img style="width: 350px; height: 100px; border-radius: 5px; object-fit: cover;"
                                :src="item.coursePicture">
                        </div>

                        <div style="font-size: 13px;">
                            {{item.name}}
                        </div>
                    </a>
                </div>
            </div>
            <!-- <input
                style="width: 90%; border-radius: 5px; border: 1px solid black; background: rgba(255, 255, 255, 0.607);"> -->

        </div>


        <div v-if="nowuserprofile.profilePicture"
            style="background: rgba(255, 255, 255, 0.861); position: fixed; bottom: 5vh; left: 20px; border-radius: 20px; z-index:999; padding: 5px 10px; opacity: .85; width: 65vw; padding: 20px; backdrop-filter: blur(5px); max-height: 30vh; overflow: hidden; min-height: 300px; max-width: 1000px;">

            <div style="position: absolute; right: 10px; top: 10px;" @click="closedetail()">x</div>


            <div class="row">

                <div class="col-4"> <img style="max-height: 25vh; width: 100%; border-radius: 20px; object-fit: contain;
                    background: white;" :src="nowuserprofile.profilePicture">
                </div>
                <div class="col-8">
                    <h3>Racer Details <span
                            v-if="crowd[nowuserprofile.locationid]&&crowd[nowuserprofile.locationid].length>1">({{crowdpageindex+1}}/{{crowd[nowuserprofile.locationid].length}})</span>
                    </h3>
                    <div class="row">
                        <div class="col-4">Nickname: </div>
                        <div class="col-8">{{nowuserprofile.nickname}}</div>
                    </div>




                    <div class="row">
                        <div class="col-4">Bib: </div>
                        <div class="col-8">{{nowuserprofile.bibNumber}}</div>
                    </div>

                    <div class="row">
                        <div class="col-4">Nationality: </div>
                        <div class="col-8"> {{nowuserprofile.nationality}} <img style="width: 30px;"
                                :src="'https://flagsapi.com/'+nowuserprofile.nationality+'/flat/64.png'"></div>
                    </div>

                    <div class="row">
                        <div class="col-4">Experience: </div>
                        <div class="col-8"> {{nowuserprofile.experienceLevel}}</div>
                    </div>

                    <div class="row">
                        <div class="col-4">Distance: </div>
                        <div class="col-8"> {{nowuserprofile.distance?nowuserprofile.distance:'/'}} km</div>
                    </div>
                    <!-- 
                    <div class="row">
                        <div class="col-4">all: </div>
                        <div class="col-8"> {{nowuserprofile}}</div>
                    </div> -->



                    <div class="row">
                        <div class="col-4"> Ranking: </div>
                        <div class="col-8"> {{nowuserprofile.ranking?nowuserprofile.ranking:'/'}}</div>
                    </div>

                    <div class="row">
                        <div class="col-4"> Last Update: </div>
                        <div class="col-8"> {{formatDate(nowuserprofile.checkInTime)}}</div>
                    </div>

                    <div class="row">
                        <div class="col-4"> Cut Off Time: </div>
                        <div class="col-8"> {{timeleft(nowuserprofile.cutOffTime.seconds*1000)}}</div>
                    </div>


                    <div style=" position: absolute; right: 10px; bottom: 10px;"
                        v-if="crowd[nowuserprofile.locationid]&&crowd[nowuserprofile.locationid].length>1"><img
                            style="width:30px" src="https://cdn-icons-png.flaticon.com/512/109/109681.png"
                            @click="nextcrowduser()"></div>
                    <!-- {{nowuserprofile}} -->

                </div>

            </div>


        </div>

        <div style=" height: calc(100vh - 75px); overflow: scroll; position: fixed; top: 75px; left: 20px; z-index: 9;">


            <div v-for="item in courselist" style="" class="courseselect">
                <a style="color: black;" :href="'/?courseid='+item._id+'&eventid='+eventid">
                    <img :src="item.coursePicture"
                        style="width: 70px;height: 70px; border-radius: 10px; margin-bottom: 10px; margin-top: 5px;">
                    <h1 style="font-size: 12px;">{{item.name}}</h1>
                </a>
            </div>



        </div>

        <div id="menu" v-if="racerdata.data"
            style="position: fixed; top: 50%; width: 30vw; height: 80vh; -ms-transform: translateY(-50%); transform: translateY(-50%); background: rgba(255, 255, 255, 0.89); right: 10px; z-index:999; overflow-y: scroll; overflow-x: hidden; border-radius: 10px; background: linear-gradient(#008cd1,#2da04d); color: white; opacity: .9;     background: rgb(0 140 209 / 81%)">
            <h2 v-if="racerdata.courseDetails" style="margin: 20px;">
                {{racerdata.courseDetails.name}}</h2>

            <template v-if="sidepanelmode=='tracking'">
                <template v-if="!(racerdata.data.filter(x=>x.racerStatus=='START'||x.racerStatus=='RACING').length==0)">
                    <div class="row">
                        <div class="col-13"> <input @keyup="searchuser($event)" @change="searchuser($event)"
                                v-model="searchinput" placeholder="Enter Your Keywords" type="search"
                                class="form-search">
                        </div>
                        <!-- <div class="col-1"> <img
                            src="data:image/svg+xml,%3Csvg id='Layer_1' data-name='Layer 1' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 133.33 136'%3E%3Cg id='surface1'%3E%3Cpath d='M94.11,80.7A51.13,51.13,0,1,0,78.38,95.19l37.71,37.48a10.7,10.7,0,1,0,15.52-14.74c-.13-.14-.25-.26-.39-.39ZM52.33,84.2a33,33,0,1,1,33-33.05,33,33,0,0,1-33,33.05Z' transform='translate(-1.22 0)' fill='%23008cd2'/%3E%3C/g%3E%3C/svg%3E"
                            style="width: 100%; padding: 12px; padding-right: 25px;">
                    </div> -->
                        <!-- <div class="col-1"> <img src="https://cdn-icons-png.flaticon.com/512/6590/6590958.png"
                                class="filterbutton" @click="togglefiltermenu">
                        </div> -->


                        <div class="col-12" v-if="menuopen">
                            <div class="filtertag" @click="filtertable('all')">All</div>
                            <div class="filtertag" @click="filtertable('topf')">Top Females</div>
                            <div class="filtertag" @click="filtertable('topm')">Top Males</div>
                        </div>
                    </div>


                    <div class="row" style="padding: 10px 20px; width: 95%;">
                        <div class="col-5">Name</div>
                        <div class="col-5">Bib</div>
                        <div class="col-2">Show</div>

                    </div>
                    <template v-for="item in racerdata.data"
                        v-if="racerdata.data.filter(x=>x.racerStatus=='START'||x.racerStatus=='RACING').length>0">
                        <div class="row" v-if="item.racerStatus=='START'||item.racerStatus=='RACING'"
                            style="padding: 10px 20px; width: 95%; font-size: 13px;">
                            <div class="col-5 myclickable" @click="gotoracer(item)">{{item.nickname}}</div>
                            <!-- <div class="col-5">{{item.racerStatus}}</div> -->
                            <div class="col-5">{{item.bibNumber}}</div>

                            <div class="col-2">
                                <label class="container">
                                    <input type="checkbox" v-model="tracking[item.userId]">
                                    <span @click="updatemap()" class="checkmark"></span>
                                </label>

                            </div>

                        </div>
                    </template>
                </template>
                <template v-if="racerdata.data.filter(x=>x.racerStatus=='START'||x.racerStatus=='RACING').length==0">
                    <div style="margin-left: 20px; font-size: 20px; opacity: .9;">No racer is running right now. <div>
                            STAY TUNED!</div>
                    </div>

                    <img style=" opacity: .4;"
                        src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/e1cb4492-b2e6-4528-8634-7bc636ec03f1/d8kril2-41567055-e874-4fd5-a948-433ced1425e2.gif?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7InBhdGgiOiJcL2ZcL2UxY2I0NDkyLWIyZTYtNDUyOC04NjM0LTdiYzYzNmVjMDNmMVwvZDhrcmlsMi00MTU2NzA1NS1lODc0LTRmZDUtYTk0OC00MzNjZWQxNDI1ZTIuZ2lmIn1dXSwiYXVkIjpbInVybjpzZXJ2aWNlOmZpbGUuZG93bmxvYWQiXX0.wiCpkJLnmkAp_G5rQc8tL7UFdQZoR9VTY0lE9unwrSY">
                </template>

            </template>

            <template v-if="sidepanelmode=='chat'">

                <div id="messagearea" style="height: calc(100% - 150px); overflow: scroll; overflow-x: hidden;
             padding-left: 10px; padding-right: 10px; width: calc(100% + 18px);">

                    <template v-for="item in chatlist">
                        <div v-if="item.from!=socketid"
                            style="color: black; background: rgba(255, 255, 255, 0.761); margin-bottom: 10px; border-radius: 5px; font-size: 13px; padding: 5px; width: 250px;">
                            {{generateName(item.from)}}: {{item.msg}}</div>
                        <div v-if="item.from==socketid"
                            style="color: black; background: rgba(255, 255, 255, 0.761); margin-bottom: 10px; border-radius: 5px; font-size: 13px; padding: 5px; width: 250px; margin-left: auto;">
                            me: {{item.msg}}</div>
                    </template>
                </div>


                <form @submit.prevent="addmessage"
                    style="text-align: center; position: absolute; width: 100%; bottom: 20px; font-size: 13px;">
                    <input
                        style="background: none; background: rgba(255, 255, 255, 0.761);  border-radius: 7px; border: 2px solid; width: 80%; margin-right: 2%; padding: 3px 5px;"
                        id="input" autocomplete="off" v-model="chatinput" /><button
                        style="border-radius: 7px; border: 2px solid; padding: 3px 5px; background: rgba(255, 255, 255, 0.761); "><img
                            src="https://uxwing.com/wp-content/themes/uxwing/download/communication-chat-call/send-icon.png"
                            style="width: 15px;"></button>
                </form>
            </template>
        </div>
        <div id='mapboxframe' style='width: 100vw; height: 100vh;'></div>
    </div>


    <script>
        var map
        const { createApp } = Vue

        const VueApp = createApp({
            async mounted() {
                this.getallevents()
            },
            data() {
                return {
                    courseid: true,
                    targeteventid: '',
                    eventid: '',
                    livemapdata: {},
                    tracking: {},
                    racerdata: {},
                    stat: {},
                    tableMode: 'realtime',
                    modeButton: 'Switch to Finish Mode',
                    chatinput: '',
                    socketid: '',
                    chatlist: [],
                    nameList: {},
                    connectCounter: 0,
                    sidepanelmode: 'tracking',
                    markershowing: [],
                    db: null,
                    nowuserprofile: {},
                    crowd: {},
                    searchinput: "",
                    menuopen: false,
                    crowdpageindex: 0,
                    nowlocationid: '',
                    nowdate: '',
                    trackingtopfive: true,
                    eventdata: [],
                    coursedata: [],
                    courselist: [],
                    chooselvl: 'Event'
                }
            },
            methods: {
                timeleft(date) {

                    const nowdate = this.nowdate
                    date = new Date(date)
                    return this.dhm(date - nowdate)

                },
                dhm(t) {
                    var cd = 24 * 60 * 60 * 1000,
                        ch = 60 * 60 * 1000,
                        d = Math.floor(t / cd),
                        h = Math.floor((t - d * cd) / ch),
                        m = Math.round((t - d * cd - h * ch) / 60000),
                        pad = function (n) { return n < 10 ? '0' + n : n; };
                    if (m === 60) {
                        h++;
                        m = 0;
                    }
                    if (h === 24) {
                        d++;
                        h = 0;
                    }
                    return (d ? d + 'd ' : '') + pad(h) + "h " + pad(m) + "m " + Math.floor(t / 1000 % 60) + 's'
                },
                async nextcrowduser() {
                    const userinfo = this.racerdatabyid()
                    const userCoor = this.getUserCoor()
                    this.crowdpageindex = (this.crowdpageindex + 1) % (this.crowd[this.nowlocationid].length)
                    const crowduserid = this.crowd[this.nowlocationid][this.crowdpageindex]
                    this.nowuserprofile = await this.getUserProfile(crowduserid)
                    this.nowuserprofile = { ...this.nowuserprofile, ...userinfo[crowduserid], ...userCoor[crowduserid], locationid: this.nowlocationid }
                },
                padTo2Digits(num) {
                    return num.toString().padStart(2, '0');
                },
                formatDate(date) {
                    date = new Date(date)
                    return (
                        [
                            date.getFullYear(),
                            this.padTo2Digits(date.getMonth() + 1),
                            this.padTo2Digits(date.getDate()),
                        ].join('-') +
                        ' ' +
                        [
                            this.padTo2Digits(date.getHours()),
                            this.padTo2Digits(date.getMinutes()),
                            this.padTo2Digits(date.getSeconds()),
                        ].join(':')
                    );
                },
                searchuser(event) {
                    console.log('search user')
                    this.racerdata.data.sort((a, b) => {
                        const bibsim = this.similarity(this.searchinput, b.bibNumber) - this.similarity(this.searchinput, a.bibNumber)
                        const namesim = this.similarity(this.searchinput, b.nickname) - this.similarity(this.searchinput, a.nickname)
                        return namesim ? namesim : bibsim
                    })

                },
                similarity(s1, s2) {
                    var longer = s1;
                    var shorter = s2;
                    if (s1.length < s2.length) {
                        longer = s2;
                        shorter = s1;
                    }
                    var longerLength = longer.length;
                    if (longerLength == 0) {
                        return 1.0;
                    }
                    return (longerLength - this.editDistance(longer, shorter)) / parseFloat(longerLength);
                }, editDistance(s1, s2) {
                    s1 = s1.toLowerCase();
                    s2 = s2.toLowerCase();

                    var costs = new Array();
                    for (var i = 0; i <= s1.length; i++) {
                        var lastValue = i;
                        for (var j = 0; j <= s2.length; j++) {
                            if (i == 0)
                                costs[j] = j;
                            else {
                                if (j > 0) {
                                    var newValue = costs[j - 1];
                                    if (s1.charAt(i - 1) != s2.charAt(j - 1))
                                        newValue = Math.min(Math.min(newValue, lastValue),
                                            costs[j]) + 1;
                                    costs[j - 1] = lastValue;
                                    lastValue = newValue;
                                }
                            }
                        }
                        if (i > 0)
                            costs[s2.length] = lastValue;
                    }
                    return costs[s2.length];
                },
                filtertable(filtertype) {
                    console.log(filtertype)
                    if (filtertype == 'all') {
                        this.racerdata.data = this.racerdata.data.map(x => {
                            return {
                                ...x, hidden: false
                            }
                        })
                    } else
                        if (filtertype == 'topm') {
                            this.racerdata.data = this.racerdata.data.map(x => {
                                if (x.gender == 'male')
                                    return {
                                        ...x, hidden: false
                                    }
                                else
                                    return {
                                        ...x, hidden: true
                                    }
                            })
                        } else if (filtertype == 'topf') {
                            this.racerdata.data = this.racerdata.data.map(x => {
                                if (x.gender == 'female')
                                    return {
                                        ...x, hidden: false
                                    }
                                else
                                    return {
                                        ...x, hidden: true
                                    }
                            })
                        }
                    this.racerdata.data.sort((a, b) => {
                        if (a.ranking - 0 < b.ranking - 0)
                            return -1;
                        if (a.ranking - 0 > b.ranking - 0)
                            return 1;
                        return 0;
                    })
                },
                switchsidepanelmode(mode) {
                    this.sidepanelmode = mode
                },
                closedetail() {
                    this.nowuserprofile = {}
                },
                addmessage(msg, from) {
                    if (msg && from) {
                        this.chatlist.push(msg)
                    } else if (this.chatinput) {
                        socket.emit('chat message', { msg: this.chatinput, from: socket.id });
                        this.chatinput = ''
                    }
                },
                racerdatabyid() {
                    let temp = {}
                    this.racerdata.data.map(x => {
                        if (!temp[x.userId])
                            temp[x.userId] = x
                        else if (x.createdAt.seconds > temp[x.userId].createdAt.seconds)
                            temp[x.userId] = x
                        else if (x.createdAt.seconds == temp[x.userId].createdAt.seconds)
                            if (x.createdAt.nanoseconds > temp[x.userId].createdAt.nanoseconds)
                                temp[x.userId] = x
                    })
                    return temp
                },
                msToTime: function (duration) {
                    duration = duration * 1000
                    var milliseconds = Math.floor((duration % 1000) / 100),
                        seconds = Math.floor((duration / 1000) % 60),
                        minutes = Math.floor((duration / (1000 * 60)) % 60),
                        hours = Math.floor((duration / (1000 * 60 * 60)) % 24);

                    hours = (hours < 10) ? "0" + hours : hours;
                    minutes = (minutes < 10) ? "0" + minutes : minutes;
                    seconds = (seconds < 10) ? "0" + seconds : seconds;

                    return hours + ":" + minutes + ":" + seconds + "." + milliseconds;
                }, sortByCompleteTime() {
                    console.log(this.racerdata)
                    this.racerdata.data.sort((a, b) => {
                        if (!a.completionTime) return 1
                        if (!b.completionTime) return -1
                        if (a.completionTime.seconds - 0 < b.completionTime.seconds - 0)
                            return 1;
                        if (a.completionTime.seconds - 0 > b.completionTime.seconds - 0)
                            return -1;
                        return 0;
                    })
                }, sortByRanking() {
                    this.racerdata.data.sort((a, b) => {
                        if (a.ranking - 0 < b.ranking - 0)
                            return -1;
                        if (a.ranking - 0 > b.ranking - 0)
                            return 1;
                        return 0;
                    })
                }, toggleTableMode() {
                    if (this.tableMode == 'realtime') {
                        console.log('sort by completion')
                        this.sortByRanking()
                        this.modeButton = "Switch to Real Time Mode"
                        this.tableMode = 'finish'
                    } else if (this.tableMode == 'finish') {
                        console.log('sort by finish')
                        this.sortByCompleteTime()
                        this.modeButton = "Switch to Finish Mode"
                        this.tableMode = 'realtime'
                    }
                }, dateTimeToString(datetime) {
                    datetime = datetime * 1000
                    function pad(v) {
                        return (v < 10) ? '0' + v : v
                    }
                    function getDateString(datetime) {
                        const d = new Date(datetime)
                        var year = d.getFullYear();
                        var month = pad(d.getMonth() + 1);
                        var day = pad(d.getDate());
                        var hour = pad(d.getHours());
                        var min = pad(d.getMinutes());
                        var sec = pad(d.getSeconds());
                        // return year + month + day + hour + min + sec;
                        return year + "-" + month + "-" + day + " " + hour + ":" + min + ":" + sec;
                        //YYYYMMDDhhmmss
                    }
                    return getDateString(datetime)

                }, getUserCoor() {
                    let userCoor = {}
                    const nowdata = this.livemapdata
                    for (j in nowdata) {
                        const userId = j

                        if (userCoor[userId]) {
                            if (nowdata[j].checkInTime >= userCoor[userId].checkInTime)
                                userCoor[userId] = nowdata[j]
                        } else {
                            userCoor[userId] = nowdata[j]
                        }
                    }
                    return userCoor
                },
                async gotoracer(item) {
                    let userCoor = this.getUserCoor()
                    const location = userCoor[item.userId].location
                    console.log(userCoor[item.userId])
                    this.flytomap([location.longitude, location.latitude])
                    // const locationid = [location.longitude, location.latitude].join(',')
                    // this.nowlocationid = locationid

                },

                chooseevent(item) {
                    this.chooselvl = 'Course'
                    const eventid = (item._id)
                    console.log(eventid)
                    this.targeteventid = eventid
                    this.getcourses(eventid)
                },
                updatemap() {
                    setTimeout(() => {
                        console.log('updatemap')
                        const nowdata = this.livemapdata

                        let coordinates = []
                        let propic = []
                        let userinfo = this.racerdatabyid()
                        let userCoor = this.getUserCoor()
                        let userids = []
                        this.crowd = {}
                        this.sortByRanking()

                        let trackingcounter = 0;
                        for (j in userCoor) {
                            if (!!this.tracking[j]) {
                                if (userinfo[j].racerStatus == 'START' || userinfo[j].racerStatus == 'RACING') {
                                    const locationid = userCoor[j].location.longitude + ',' + userCoor[j].location.latitude
                                    if (!this.crowd[locationid]) this.crowd[locationid] = []
                                    this.crowd[locationid].push(j)
                                }
                            }
                        }




                        for (j in userCoor) {

                            // if (userinfo[j].racerStatus == 'START' || userinfo[j].racerStatus == 'RACING')
                            if (!!this.tracking[j]) {
                                console.log('tracking ', j)
                                console.log(userinfo[j], userinfo[j].racerStatus == 'START' || userinfo[j].racerStatus == 'RACING')
                                if (userinfo[j].racerStatus == 'START' || userinfo[j].racerStatus == 'RACING') {


                                    const locationid = userCoor[j].location.longitude + ',' + userCoor[j].location.latitude



                                    coordinates.push([userCoor[j].location.longitude, userCoor[j].location.latitude])


                                    if (this.crowd[locationid].length > 1)
                                        // propic.push('https://i.ibb.co/6XRWLwq/half-marathon-running-clip-art-marathon-afb5eccca8c7044156ba07f0a9ab12ea.png')
                                        propic.push('https://ui-avatars.com/api/?background=2da04d&color=fff&length=3&bold=true&name=' + this.crowd[locationid].length)
                                    else
                                        propic.push('https://ui-avatars.com/api/?background=fff&color=000&length=3&bold=true&name=' + userinfo[j].nickname.split(' ').join('+'))

                                    userids.push(j)
                                }

                            }


                            // coordinates.push([userCoor[j].location.longitude, userCoor[j].location.latitude])
                            // propic.push('https://ui-avatars.com/api/?name=' + userinfo[j].nickname.split(' ').join('+'))
                            // propic.push('https://ui-avatars.com/api/?name=John+Doe')

                        }

                        // console.log(userCoor)
                        // console.log(coordinates)
                        // console.log(propic)

                        /* const coordinates = [...Object.entries(nowdata).filter(x => {
                             if (!!this.tracking[x[0]]) {
                                 console.log('tracking ', x[0])
                                 console.log(x[1])
                             }
                             return !!this.tracking[x[0]]
                             // return userIdDetails[x[0]].racerStatus == 'START' || userIdDetails[x[0]].racerStatus == 'PRESTART' || userIdDetails[x[0]].racerStatus == 'RACING'
                         }).map(x => [x[1].location.longitude, x[1].location.latitude])]
                         console.log(coordinates)*/


                        // map.getSource('point').setData({
                        //     'type': 'FeatureCollection',
                        //     'features': coordinates.map(x => {
                        //         return {
                        //             'type': 'Feature',
                        //             'geometry': {
                        //                 'type': 'Point',
                        //                 'coordinates': x
                        //             }
                        //         }
                        //     })
                        // });


                        for (let j = 0; j < this.markershowing.length; j++) {
                            this.markershowing[j].remove()
                        }

                        for (let j = 0; j < coordinates.length; j++) {
                            const marker = coordinates[j]
                            // Create a DOM element for each marker.
                            const el = document.createElement('div');
                            const width = 30;
                            const height = 30;
                            el.className = 'marker';
                            el.style.backgroundImage = `url(${propic[j]})`;//`url(https://placekitten.com/g/${width}/${height}/)`;
                            el.style.width = `${width}px`;
                            el.style.height = `${height}px`;
                            el.style.backgroundSize = '100%';
                            el.style.opacity = '0.9';
                            el.style.border = '2px solid #2da04d'
                            const tempuserid = userids[j]
                            this.crowdpageindex = 0
                            el.addEventListener('click', async () => {
                                // alert(JSON.stringify(userinfo[tempuserid]));
                                const locationid = marker.join(',')
                                this.nowlocationid = locationid
                                userinfo = this.racerdatabyid()
                                userCoor = this.getUserCoor()
                                console.log(userinfo[tempuserid])
                                console.log(userCoor[tempuserid])
                                if (VueApp.$data.crowd[locationid].length == 1) {
                                    VueApp.$data.nowuserprofile = await VueApp.getUserProfile(tempuserid)
                                    VueApp.$data.nowuserprofile = { ...VueApp.$data.nowuserprofile, ...userinfo[tempuserid], ...userCoor[tempuserid], locationid: locationid }
                                } else {
                                    const crowduserid = VueApp.$data.crowd[locationid][this.crowdpageindex]
                                    VueApp.$data.nowuserprofile = await VueApp.getUserProfile(crowduserid)
                                    VueApp.$data.nowuserprofile = { ...VueApp.$data.nowuserprofile, ...userinfo[crowduserid], ...userCoor[crowduserid], locationid: locationid }
                                }

                            });

                            // Add markers to the map.
                            this.markershowing[j] = new mapboxgl.Marker(el)
                                .setLngLat(marker)
                                .addTo(map);
                            // console.log('elements ')
                            // console.log(el)
                            console.log(propic[j])
                        }





                    }, 100);

                }, generateName(id) {
                    if (id == 'system') return 'Trailme'
                    console.log(this.nameList)
                    console.log(this.nameList[id])
                    if (this.nameList[id])
                        return this.nameList[id];
                    const finalName = nameList[Math.floor(Math.random() * nameList.length)] + ' ' + nameList[Math.floor(Math.random() * nameList.length)];
                    this.nameList[id] = finalName
                    return finalName
                },
                getallevents() {
                    var xhr = new XMLHttpRequest();
                    xhr.withCredentials = true;

                    xhr.addEventListener("readystatechange", function () {
                        if (this.readyState === 4) {
                            const eventdata = (JSON.parse(this.responseText)).data;
                            VueApp.$data.eventdata = eventdata
                            VueApp.$data.eventdata = VueApp.$data.eventdata.filter(x => {
                                if (!x.name) return false
                                if (x.name.indexOf('MacLehose') != -1 || x.name.indexOf('New Year') != -1)
                                    return true
                                else return false
                            })
                            console.log(eventdata)
                        }
                    });

                    xhr.open("GET", "/getallevents");

                    xhr.send();
                }, getcourses(eventid) {

                    var xhr = new XMLHttpRequest();
                    xhr.withCredentials = true;

                    xhr.addEventListener("readystatechange", function () {
                        if (this.readyState === 4) {
                            const coursedata = (JSON.parse(this.responseText)).data;
                            VueApp.$data.coursedata = coursedata
                            console.log(coursedata)
                        }
                    });

                    xhr.open("GET", "/getcourses/" + eventid);

                    xhr.send();
                }
            },
            watch: {
                livemapdata: function (val) {
                    console.log('livemapdata change')
                    this.updatemap()
                }, tracking: function (val) {
                    console.log('tracking change')
                    this.updatemap()
                }
            }
        }).mount('#app')



        var socket = io();

        socket.on('chat message', function (msg) {
            VueApp.$data.socketid = socket.id
            console.log(msg)
            // window.scrollTo(0, document.body.scrollHeight);
            VueApp.addmessage(msg, 'other')
            if (document.getElementById("messagearea"))
                document.getElementById("messagearea").scrollTo(0, document.getElementById("messagearea").scrollHeight);
        });

        socket.on('connectCounter', function (connectCounter) {
            VueApp.$data.connectCounter = connectCounter
        })



        var nameList = [
            'Time', 'Past', 'Future', 'Dev',
            'Fly', 'Flying', 'Soar', 'Soaring', 'Power', 'Falling',
            'Fall', 'Jump', 'Cliff', 'Mountain', 'Rend', 'Red', 'Blue',
            'Green', 'Yellow', 'Gold', 'Demon', 'Demonic', 'Panda', 'Cat',
            'Kitty', 'Kitten', 'Zero', 'Memory', 'Trooper', 'XX', 'Bandit',
            'Fear', 'Light', 'Glow', 'Tread', 'Deep', 'Deeper', 'Deepest',
            'Mine', 'Your', 'Worst', 'Enemy', 'Hostile', 'Force', 'Video',
            'Game', 'Donkey', 'Mule', 'Colt', 'Cult', 'Cultist', 'Magnum',
            'Gun', 'Assault', 'Recon', 'Trap', 'Trapper', 'Redeem', 'Code',
            'Script', 'Writer', 'Near', 'Close', 'Open', 'Cube', 'Circle',
            'Geo', 'Genome', 'Germ', 'Spaz', 'Shot', 'Echo', 'Beta', 'Alpha',
            'Gamma', 'Omega', 'Seal', 'Squid', 'Money', 'Cash', 'Lord', 'King',
            'Duke', 'Rest', 'Fire', 'Flame', 'Morrow', 'Break', 'Breaker', 'Numb',
            'Ice', 'Cold', 'Rotten', 'Sick', 'Sickly', 'Janitor', 'Camel', 'Rooster',
            'Sand', 'Desert', 'Dessert', 'Hurdle', 'Racer', 'Eraser', 'Erase', 'Big',
            'Small', 'Short', 'Tall', 'Sith', 'Bounty', 'Hunter', 'Cracked', 'Broken',
            'Sad', 'Happy', 'Joy', 'Joyful', 'Crimson', 'Destiny', 'Deceit', 'Lies',
            'Lie', 'Honest', 'Destined', 'Bloxxer', 'Hawk', 'Eagle', 'Hawker', 'Walker',
            'Zombie', 'Sarge', 'Capt', 'Captain', 'Punch', 'One', 'Two', 'Uno', 'Slice',
            'Slash', 'Melt', 'Melted', 'Melting', 'Fell', 'Wolf', 'Hound',
            'Legacy', 'Sharp', 'Dead', 'Mew', 'Chuckle', 'Bubba', 'Bubble', 'Sandwich',
            'Smasher', 'Extreme', 'Multi', 'Universe', 'Ultimate', 'Death', 'Ready', 'Monkey', 'Elevator', 'Wrench', 'Grease', 'Head', 'Theme', 'Grand', 'Cool', 'Kid', 'Boy',
            'Girl', 'Vortex', 'Paradox'
        ];



        setInterval(() => {
            VueApp.$data.nowdate = new Date()
        }, 1000);


    </script>




    <!--=======================Javascript============================-->
    <!-- build:js assets/js/app.min.js -->
    <!--=== Modernizr Min Js ===-->
    <script src="assets/js/modernizr.min.js"></script>
    <!--=== jQuery Min Js ===-->
    <script src="assets/js/jquery.min.js"></script>
    <!--=== jQuery Migration Min Js ===-->
    <script src="assets/js/jquery-migrate.min.js"></script>
    <!--=== Popper Min Js ===-->
    <script src="assets/js/popper.min.js"></script>
    <!--=== Bootstrap Min Js ===-->
    <script src="assets/js/bootstrap.min.js"></script>
    <!--=== Select2 Min Js ===-->
    <script src="assets/js/select2.full.min.js"></script>
    <!--=== Data Table Min Js ===-->
    <script src="assets/js/datatables.min.js"></script>
    <!--=== ChartJS Min Js ===-->
    <script src="assets/js/chart.min.js"></script>
    <!--=== jQuery Vector Map Min Js ===-->
    <script src="assets/js/jquery.vmap.min.js"></script>
    <!--=== jQuery Vector World Min Js ===-->
    <script src="assets/js/jquery.vmap.world.js"></script>

    <!--=== APP Js ===-->
    <!-- <script src="assets/js/app.js"></script> -->
    <!--=== Active Js ===-->
    <!-- <script src="assets/js/active.js"></script> -->

    <!-- endbuild -->
</body>

</html>